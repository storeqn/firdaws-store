<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø¹Ø±Ø¶ Ø§Ù„ÙØ±Ø¯ÙˆØ³</title>

  <!-- PWA / Safari -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2b2d5f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Ù…Ø¹Ø±Ø¶ Ø§Ù„ÙØ±Ø¯ÙˆØ³">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{
      --bg:#0f1026;
      --bg2:#171a3a;
      --text:#eef2ff;
      --muted:#b9c0ff;
      --line:rgba(255,255,255,.10);
      --brand:#5b7cff;
      --brand2:#3a5cff;
      --ok:#16a34a;
      --danger:#ef4444;
      --shadow:0 14px 34px rgba(0,0,0,.25);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,"Segoe UI",Tahoma,Arial;
      background:
        radial-gradient(1200px 600px at 50% -200px, rgba(91,124,255,.25), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      padding-bottom: 92px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø«Ø§Ø¨Øª */
    }
    a{color:inherit; text-decoration:none}
    button,input,textarea{font-family:inherit}

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      background: rgba(18,20,48,.78);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
    }
    .bar{
      max-width:1200px; margin:auto;
      padding:10px 12px;
      display:grid; grid-template-columns: 1fr auto 1fr;
      align-items:center; gap:10px;
    }
    .brand{
      justify-self:center;
      text-align:center;
    }
    .brand .t{
      font-weight:1000;
      font-size:18px;
      line-height:1.1;
      letter-spacing:.2px;
    }
    .brand .s{
      margin-top:3px;
      font-size:12px;
      color: rgba(185,192,255,.95);
    }
    .leftTools,.rightTools{display:flex; gap:8px; align-items:center}
    .leftTools{justify-self:start}
    .rightTools{justify-self:end}

    .iconBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      display:flex; gap:8px; align-items:center;
      font-weight:1000;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .badge{
      min-width:22px; height:22px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(91,124,255,.20);
      border: 1px solid rgba(91,124,255,.35);
      font-size:12px; font-weight:1000;
    }

    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius:999px;
      padding:10px 12px;
      width:min(520px, 92vw);
      display:flex; gap:10px; align-items:center;
      margin:0 auto 10px;
    }
    .pill input{
      border:0; outline:0; width:100%;
      background:transparent; font-size:14px;
      color:var(--text);
    }
    .pill input::placeholder{color: rgba(185,192,255,.75)}

    /* Bars (categories/subcategories/brands) */
    .catsWrap{
      max-width:1200px;
      margin:auto;
      padding:0 12px 12px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .mini{
      color: rgba(185,192,255,.85);
      font-size:13px;
      line-height:1.55;
    }
    .cats{
      max-width:1200px;
      margin:auto;
      padding:0 12px 12px;
      display:flex;
      gap:8px;
      overflow:auto;
    }
    .catBtn{
      white-space:nowrap;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
    }
    .catBtn.active{
      background: linear-gradient(135deg, rgba(91,124,255,.95), rgba(58,92,255,.95));
      border-color: rgba(91,124,255,.50);
    }

    /* Layout */
    .wrap{max-width:1200px; margin:auto; padding:14px 12px}
    .secHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:12px 0 10px;
    }
    .secHead .h{font-size:16px; font-weight:1000}
    .secHead .sub{color: rgba(185,192,255,.85); font-size:13px}

    /* Product grid */
    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(4, 1fr);
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 720px){ .grid{grid-template-columns: repeat(2, 1fr);} }

    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .posRel{position:relative}
    .img{
      width:100%;
      height:160px;
      object-fit:contain;
      background: rgba(255,255,255,.06);
      display:block;
      cursor:pointer;
    }
    @media (max-width: 720px){ .img{height:140px} }

    .p{padding:10px}
    .name{
      font-weight:1000;
      font-size:13.5px;
      line-height:1.25;
      min-height:34px;
      cursor:pointer;
    }
    .cat{
      font-size:12px;
      color: rgba(185,192,255,.85);
      margin-top:6px;
    }
    .row{
      display:flex;
      align-items:baseline;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap
    }
    .price{font-weight:1000; color:#cfe0ff; font-size:14px}
    .old{font-size:12px; color: rgba(185,192,255,.85); text-decoration:line-through}

    .btnRow{display:flex; gap:8px; margin-top:10px}
    .btn{
      flex:1;
      border-radius:14px;
      padding:10px 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:1000;
    }
    .btn.add{
      background: rgba(91,124,255,.18);
      border-color: rgba(91,124,255,.35);
    }
    .btn.order{
      background: linear-gradient(135deg, rgba(22,163,74,.95), rgba(34,197,94,.95));
      border-color: transparent;
      color:#fff;
    }

    .tag{
      position:absolute; top:10px; right:10px;
      background:rgba(239,68,68,.95);
      color:#fff;
      font-weight:1000;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
    }
    .tag2{
      position:absolute; top:10px; left:10px;
      background:rgba(91,124,255,.95);
      color:#fff;
      font-weight:1000;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
    }

    /* Always-visible cart bar (bottom) */
    .cartBar{
      position:fixed;
      left:12px; right:12px; bottom:12px;
      z-index:60;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(18,20,48,.85);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 46px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      cursor:pointer;
    }
    .cartBar .sum{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 140px;
    }
    .cartBar .sum .t{font-size:12px; color: rgba(185,192,255,.85)}
    .cartBar .sum .v{font-weight:1000; font-size:14px}
    .cartBar .go{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:1000;
      color:#fff;
      background: linear-gradient(135deg, rgba(91,124,255,.95), rgba(58,92,255,.95));
      display:flex; gap:10px; align-items:center;
      white-space:nowrap;
      pointer-events:none;
    }
    .cartBar .go .b{
      background: rgba(255,255,255,.20);
      border: 1px solid rgba(255,255,255,.25);
      border-radius:999px;
      padding:2px 8px;
      font-size:12px;
      font-weight:1000;
    }

    /* Drawers */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:90}
    .overlay.show{display:block}

    .drawer{
      position:fixed; top:0; left:0;
      height:100vh; width:min(440px, 94vw);
      background: #0f1026;
      box-shadow: 0 30px 70px rgba(0,0,0,.40);
      transform: translateX(-110%);
      transition: .2s ease;
      z-index:100;
      display:flex; flex-direction:column;
      border-right: 1px solid rgba(255,255,255,.10);
    }
    .drawer.open{transform:translateX(0)}
    .dHead{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; align-items:center; gap:10px
    }
    .dHead .t{font-weight:1000}
    .x{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:1000
    }
    .dBody{padding:14px; overflow:auto; flex:1}
    .dFoot{padding:14px; border-top:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03)}

    .form{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .form input, .form textarea{
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
      font-weight:700;
      background: rgba(255,255,255,.06);
      color: var(--text);
    }
    .form input::placeholder, .form textarea::placeholder{color: rgba(185,192,255,.70)}
    .form .full{grid-column:1 / -1}
    .sumLine{display:flex; justify-content:space-between; color: rgba(185,192,255,.85); font-size:13px; margin-top:6px}
    .sumLine b{color:var(--text)}
    .send{
      width:100%;
      border:0; cursor:pointer;
      border-radius:14px;
      padding:12px 12px;
      font-weight:1000;
      background: linear-gradient(135deg, rgba(91,124,255,.95), rgba(58,92,255,.95));
      color:#fff;
    }
    .clear{
      width:100%;
      border:1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      color: #ffb4b4;
      border-radius:14px;
      padding:12px 12px;
      font-weight:1000;
      cursor:pointer;
      margin-top:8px;
    }

    .cartRow{
      display:flex; gap:10px;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.10);
      align-items:flex-start;
    }
    .thumb{
      width:58px; height:58px;
      border-radius:14px;
      object-fit:contain;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10)
    }
    .cMain{flex:1}
    .cName{font-weight:1000; font-size:13px}
    .cMeta{color: rgba(185,192,255,.80); font-size:12px; margin-top:6px}
    .qty{display:flex; gap:8px; align-items:center; margin-top:8px}
    .qbtn{
      width:32px; height:32px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:1000
    }

    /* Product details drawer (right) */
    #prodDrawer{
      left:auto; right:0;
      transform:translateX(110%);
      border-right:0;
      border-left:1px solid rgba(255,255,255,.10)
    }
    #prodDrawer.open{transform:translateX(0)}
    .prodImg{
      width:100%;
      height:240px;
      object-fit:contain;
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
    }
  </style>
</head>

<body>
<header>
  <div class="bar">
    <div class="leftTools">
      <button class="iconBtn" onclick="openCart()">ğŸ›’ Ø§Ù„Ø³Ù„Ø© <span class="badge" id="cartCount">0</span></button>
    </div>

    <div class="brand">
      <div class="t">Ù…Ø¹Ø±Ø¶ Ø§Ù„ÙØ±Ø¯ÙˆØ³</div>
      <div class="s">Ù„Ù„Ù‡ÙˆØ§ØªÙ ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</div>
    </div>

    <div class="rightTools">
      <button class="iconBtn" onclick="scrollToShop()">ğŸ›ï¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
    </div>
  </div>

  <div class="pill">
    ğŸ”
    <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." />
  </div>

  <div class="catsWrap">
    <button class="iconBtn" type="button" onclick="toggleCats()">ğŸ“‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
    <div class="mini">Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
  </div>

  <div class="cats" id="catsBar" style="display:none"></div>
  <div class="cats" id="subCatsBar" style="display:none"></div>
  <div class="cats" id="brandsBar" style="display:none"></div>
</header>

<div class="wrap">
  <div class="secHead" id="shopTop">
    <div>
      <div class="h">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
      <div class="sub" id="status">ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <div id="grid" class="grid"></div>
</div>

<div class="cartBar" onclick="openCart()">
  <div class="sum">
    <div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ø©</div>
    <div class="v" id="cartSum">0 Ø¯.Ø¹</div>
  </div>
  <div class="go">
    ÙØªØ­ Ø§Ù„Ø³Ù„Ø© <span class="b" id="cartQty">0</span>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeAll()"></div>

<div class="drawer" id="cartDrawer" aria-hidden="true">
  <div class="dHead">
    <div class="t">ğŸ›’ Ø§Ù„Ø³Ù„Ø© ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</div>
    <button class="x" onclick="closeAll()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <div class="dBody" id="cartBody"></div>
  <div class="dFoot">
    <div class="sumLine"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span> <b id="sumNew">0 Ø¯.Ø¹</b></div>
    <div class="sumLine"><span>Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:</span> <span id="sumOld">0 Ø¯.Ø¹</span></div>
    <div class="sumLine"><span>Ø§Ù„ØªÙˆÙÙŠØ±:</span> <span id="sumSave">0 Ø¯.Ø¹</span></div>

    <div class="form">
      <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" />
      <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
      <input id="address" class="full" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„ + Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø©" />
      <textarea id="note" class="full" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
    </div>

    <button class="send" onclick="sendWhatsApp()">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</button>
    <button class="clear" onclick="clearCart()">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
  </div>
</div>

<div class="drawer" id="prodDrawer" aria-hidden="true">
  <div class="dHead">
    <div class="t" id="pTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</div>
    <button class="x" onclick="closeAll()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <div class="dBody" id="pBody"></div>
</div>

<script>
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vToXcV323xvYtiuz6tg-d0q_f2iwOwnYBpCRqAgSnarQ2PYVZ9Z1GJKlSmftjuajtlJ6zBfmVbRwArp/pub?output=csv";
  const WHATSAPP_NUMBER = "9647719183122";

  const $ = (id)=>document.getElementById(id);

  const state = {
    products: [],
    cats: [],
    activeCat: "",
    activeSub: "",
    activeBrand: "",
    cart: loadCart()
  };

  function loadCart(){ try { return JSON.parse(localStorage.getItem("cart")||"{}"); } catch { return {}; } }
  function saveCart(){ localStorage.setItem("cart", JSON.stringify(state.cart)); updateCartUI(); }

  function toggleCats(){
    const bar = $("catsBar");
    const show = (bar.style.display === "none" || !bar.style.display);
    bar.style.display = show ? "flex" : "none";
    if(!show){
      $("subCatsBar").style.display = "none";
      $("brandsBar").style.display = "none";
    }else{
      renderSubCatsBar();
      renderBrandsBar();
    }
  }

  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const headers = splitLine(lines[0]).map(x=>x.trim());
    return lines.slice(1).map(line=>{
      const cols = splitLine(line);
      const obj = {};
      headers.forEach((h,i)=>obj[h]=(cols[i]||"").trim());
      return obj;
    });
  }
  function splitLine(line){
    const out=[]; let cur=""; let inQ=false;
    for (let i=0;i<line.length;i++){
      const c=line[i];
      if (c === '"'){ inQ=!inQ; continue; }
      if (c === "," && !inQ){ out.push(cur); cur=""; continue; }
      cur += c;
    }
    out.push(cur);
    return out;
  }

  function money(n){ return (Number(n)||0).toLocaleString("ar-IQ"); }
  function pct(oldP, newP){
    oldP=Number(oldP||0); newP=Number(newP||0);
    if (!oldP || oldP<=newP) return 0;
    return Math.round(((oldP-newP)/oldP)*100);
  }
  function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  async function load(){
    try{
      const res = await fetch(SHEET_CSV_URL, {cache:"no-store"});
      const text = await res.text();
      const rows = parseCSV(text);

      state.products = rows
        .map((r, idx)=>({
          _i: idx,
          id: String(r.id||"").trim(),
          name: (r.name||"").trim(),
          price: Number(r.price||0),
          old_price: Number(r.old_price||0),
          offer: String(r.offer||"").toLowerCase().trim()==="yes",
          discount_note: (r.discount_note||"").trim(),
          image: (r.image||"").trim(),
          category: (r.category||"ØºÙŠØ± Ù…ØµÙ†Ù").trim(),
          sub_category: (r.sub_category||"").trim(),
          brand: (r.brand||"").trim(),
          desc: (r.desc||"").trim()
        }))
        .filter(p=>p.id && p.name && p.price);

      state.cats = [...new Set(state.products.map(p=>p.category))].sort((a,b)=>a.localeCompare(b,"ar"));

      // âœ… Ø®Ù„ÙŠ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© Ø£ÙˆÙ„ Ù‚Ø³Ù…
      if(state.cats.includes("Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©")){
        state.cats = ["Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©", ...state.cats.filter(c=>c!=="Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©")];
      }

      $("status").textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${state.products.length} Ù…Ù†ØªØ¬`;
      renderCatsBar();
      renderSubCatsBar();
      renderBrandsBar();
      renderProducts();
      updateCartUI();
    }catch(e){
      $("status").textContent = "ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· CSV ÙˆØ£Ù† Ø§Ù„Ø´ÙŠØª Ù…Ù†Ø´ÙˆØ±.";
      console.error(e);
    }
  }

  function renderCatsBar(){
    const bar = $("catsBar");
    bar.innerHTML = "";

    const allBtn = document.createElement("button");
    allBtn.className = "catBtn" + (!state.activeCat ? " active" : "");
    allBtn.textContent = "Ø§Ù„ÙƒÙ„";
    allBtn.onclick = ()=>{
      state.activeCat = "";
      state.activeSub = "";
      state.activeBrand = "";
      setActiveBtn(bar, allBtn);
      renderSubCatsBar();
      renderBrandsBar();
      renderProducts();
      scrollToShop();
    };
    bar.appendChild(allBtn);

    state.cats.forEach(cat=>{
      const b = document.createElement("button");
      b.className = "catBtn" + (state.activeCat===cat ? " active" : "");
      b.textContent = cat;
      b.onclick = ()=>{
        state.activeCat = cat;
        state.activeSub = "";
        state.activeBrand = "";
        setActiveBtn(bar, b);
        renderSubCatsBar();
        renderBrandsBar();
        renderProducts();
        scrollToShop();
      };
      bar.appendChild(b);
    });
  }

  function setActiveBtn(container, btn){
    [...container.children].forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
  }

  function renderSubCatsBar(){
    const bar = $("subCatsBar");

    if(state.activeCat !== "Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©"){
      bar.style.display = "none";
      state.activeSub = "";
      return;
    }

    const subs = [...new Set(
      state.products
        .filter(p=>p.category==="Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©")
        .map(p=>p.sub_category)
        .filter(Boolean)
    )].sort((a,b)=>a.localeCompare(b,"ar"));

    if(!subs.length){
      bar.style.display = "none";
      state.activeSub = "";
      return;
    }

    if($("catsBar").style.display === "none"){ bar.style.display="none"; return; }

    bar.style.display = "flex";
    bar.innerHTML = "";

    const all = document.createElement("button");
    all.className = "catBtn" + (!state.activeSub ? " active" : "");
    all.textContent = "ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹";
    all.onclick = ()=>{
      state.activeSub = "";
      setActiveBtn(bar, all);
      renderBrandsBar();
      renderProducts();
    };
    bar.appendChild(all);

    subs.forEach(s=>{
      const btn = document.createElement("button");
      btn.className = "catBtn" + (state.activeSub===s ? " active" : "");
      btn.textContent = s;
      btn.onclick = ()=>{
        state.activeSub = s;
        state.activeBrand = "";
        setActiveBtn(bar, btn);
        renderBrandsBar();
        renderProducts();
      };
      bar.appendChild(btn);
    });
  }

  function renderBrandsBar(){
    const bar = $("brandsBar");

    if(state.activeCat !== "Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©"){
      bar.style.display = "none";
      state.activeBrand = "";
      return;
    }

    const brands = [...new Set(
      state.products
        .filter(p=>p.category==="Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©")
        .filter(p=>!state.activeSub || p.sub_category===state.activeSub)
        .map(p=>p.brand)
        .filter(Boolean)
    )].sort((a,b)=>a.localeCompare(b,"en"));

    if(!brands.length){
      bar.style.display = "none";
      state.activeBrand = "";
      return;
    }

    if($("catsBar").style.display === "none"){ bar.style.display="none"; return; }

    bar.style.display = "flex";
    bar.innerHTML = "";

    const all = document.createElement("button");
    all.className = "catBtn" + (!state.activeBrand ? " active" : "");
    all.textContent = "ÙƒÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª";
    all.onclick = ()=>{
      state.activeBrand = "";
      setActiveBtn(bar, all);
      renderProducts();
    };
    bar.appendChild(all);

    brands.forEach(b=>{
      const btn = document.createElement("button");
      btn.className = "catBtn" + (state.activeBrand===b ? " active" : "");
      btn.textContent = b;
      btn.onclick = ()=>{
        state.activeBrand = b;
        setActiveBtn(bar, btn);
        renderProducts();
      };
      bar.appendChild(btn);
    });
  }

  function baseFilter(){
    const q = ($("q").value||"").toLowerCase().trim();
    const cat = state.activeCat;
    const sub = state.activeSub;
    const br  = state.activeBrand;

    return state.products.filter(p=>{
      const okC = !cat || p.category===cat;
      const okSub = (cat !== "Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©") || !sub || p.sub_category===sub;
      const okBr  = (cat !== "Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©") || !br  || p.brand===br;
      const okQ = !q || p.name.toLowerCase().includes(q) || (p.desc||"").toLowerCase().includes(q);
      return okC && okSub && okBr && okQ;
    });
  }

  function renderProducts(){
    const list = baseFilter().sort((a,b)=>a._i-b._i);
    const grid = $("grid");
    grid.innerHTML = "";

    list.forEach(p=>{
      const hasDisc = p.old_price && p.old_price>p.price;
      const disc = hasDisc ? pct(p.old_price, p.price) : 0;

      let meta = p.category;
      if(p.category==="Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©"){
        const parts = [];
        if(p.sub_category) parts.push(p.sub_category);
        if(p.brand) parts.push(p.brand);
        if(parts.length) meta = parts.join(" â€¢ ");
      }

      const card = document.createElement("div");
      card.className = "card posRel";
      card.innerHTML = `
        ${hasDisc ? `<div class="tag">Ø®ØµÙ… ${disc}%</div>` : ``}
        ${p.offer ? `<div class="tag2">${esc(p.discount_note || "Ø¹Ø±Ø¶ Ø®Ø§Øµ")}</div>` : ``}

        <img class="img" src="${esc(p.image)}" alt="${esc(p.name)}" loading="lazy"
             onclick="openProduct('${p.id}')" onerror="this.style.display='none'">

        <div class="p">
          <div class="name" onclick="openProduct('${p.id}')">${esc(p.name)}</div>
          <div class="cat">${esc(meta)}</div>

          <div class="row">
            <div class="price">${money(p.price)} Ø¯.Ø¹</div>
            ${hasDisc ? `<div class="old">${money(p.old_price)} Ø¯.Ø¹</div>` : ``}
          </div>

          <div class="btnRow">
            <button class="btn add" onclick="addToCart('${p.id}')">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
            <button class="btn order" onclick="orderNow('${p.id}')">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });

    if(!list.length){
      grid.innerHTML = `<div class="mini" style="padding:14px;border:1px solid rgba(255,255,255,.10);border-radius:16px;background:rgba(255,255,255,.06)">
        Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ.
      </div>`;
    }
  }

  function openProduct(id){
    const p = state.products.find(x=>x.id===id);
    if(!p) return;

    const hasDisc = p.old_price && p.old_price>p.price;
    const disc = hasDisc ? pct(p.old_price, p.price) : 0;

    let info = p.category;
    if(p.category==="Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©"){
      const parts = [];
      if(p.sub_category) parts.push(p.sub_category);
      if(p.brand) parts.push(p.brand);
      if(parts.length) info = parts.join(" â€¢ ");
    }

    $("pTitle").textContent = p.name;
    $("pBody").innerHTML = `
      <img class="prodImg" src="${esc(p.image)}" onerror="this.style.display='none'">
      <div style="margin-top:12px; font-weight:1000; font-size:16px">${esc(p.name)}</div>
      <div class="mini" style="margin-top:6px">${esc(info)}</div>

      <!-- âœ… ÙˆØµÙ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· + ÙŠØ¸Ù‡Ø± ÙƒØ§Ù…Ù„ -->
      <div class="mini" style="
        margin-top:10px;
        white-space:pre-wrap;
        line-height:1.9;
        font-size:14px;
        overflow-wrap:anywhere;
        word-break:break-word;
      ">
        ${esc(p.desc || "")}
      </div>

      <div style="margin-top:12px" class="row">
        <div class="price">${money(p.price)} Ø¯.Ø¹</div>
        ${hasDisc ? `<div class="old">${money(p.old_price)} Ø¯.Ø¹</div>` : ``}
        ${hasDisc ? `<span class="badge" style="height:auto;padding:4px 10px">Ø®ØµÙ… ${disc}%</span>` : ``}
      </div>

      <div class="btnRow" style="margin-top:14px">
        <button class="btn add" onclick="addToCart('${p.id}')">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
        <button class="btn order" onclick="orderNow('${p.id}')">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
      </div>
    `;

    showOverlay(true);
    $("prodDrawer").classList.add("open");
  }

  function addToCart(id){
    state.cart[id] = (state.cart[id]||0) + 1;
    saveCart();
  }
  function orderNow(id){
    addToCart(id);
    openCart();
  }

  function cartItems(){
    return Object.entries(state.cart).map(([id,qty])=>{
      const p = state.products.find(x=>x.id===id);
      if(!p) return null;
      const oldp = p.old_price && p.old_price>0 ? p.old_price : p.price;
      return { ...p, qty, lineNew:p.price*qty, lineOld:oldp*qty };
    }).filter(Boolean);
  }

  function updateCartUI(){
    const qty = Object.values(state.cart).reduce((a,b)=>a+b,0);
    $("cartCount").textContent = qty;
    $("cartQty").textContent = qty;

    const items = cartItems();
    const sumNew = items.reduce((a,b)=>a+b.lineNew,0);
    $("cartSum").textContent = `${money(sumNew)} Ø¯.Ø¹`;
  }

  function openCart(){
    renderCart();
    showOverlay(true);
    $("cartDrawer").classList.add("open");
  }

  function renderCart(){
    const items = cartItems();
    const body = $("cartBody");

    if(!items.length){
      body.innerHTML = `<div class="mini">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.</div>`;
    }else{
      body.innerHTML = items.map(it=>`
        <div class="cartRow">
          <img class="thumb" src="${esc(it.image)}" onerror="this.style.display='none'">
          <div class="cMain">
            <div class="cName">${esc(it.name)}</div>
            <div class="cMeta">${money(it.price)} Ø¯.Ø¹ â€¢ Ø¹Ø¯Ø¯: ${it.qty}</div>
            <div class="qty">
              <button class="qbtn" onclick="dec('${it.id}')">-</button>
              <b>${it.qty}</b>
              <button class="qbtn" onclick="inc('${it.id}')">+</button>
              <button class="qbtn" style="margin-inline-start:auto" onclick="removeItem('${it.id}')">âœ•</button>
            </div>
          </div>
        </div>
      `).join("");
    }

    const sumNew = items.reduce((a,b)=>a+b.lineNew,0);
    const sumOld = items.reduce((a,b)=>a+b.lineOld,0);
    const save = Math.max(0, sumOld - sumNew);

    $("sumNew").textContent = `${money(sumNew)} Ø¯.Ø¹`;
    $("sumOld").textContent = `${money(sumOld)} Ø¯.Ø¹`;
    $("sumSave").textContent = `${money(save)} Ø¯.Ø¹`;
  }

  function inc(id){ state.cart[id]=(state.cart[id]||0)+1; saveCart(); renderCart(); }
  function dec(id){
    if(!state.cart[id]) return;
    state.cart[id]--;
    if(state.cart[id]<=0) delete state.cart[id];
    saveCart(); renderCart();
  }
  function removeItem(id){ delete state.cart[id]; saveCart(); renderCart(); }
  function clearCart(){ state.cart={}; saveCart(); renderCart(); }

  function sendWhatsApp(){
    const items = cartItems();
    if(!items.length){ alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©"); return; }

    const name = $("name").value.trim();
    const phone = $("phone").value.trim();
    const address = $("address").value.trim();
    const note = $("note").value.trim();

    if(!name || !phone || !address){
      alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ù‡Ø§ØªÙ + Ø§Ù„Ø¹Ù†ÙˆØ§Ù†");
      return;
    }

    const sumNew = items.reduce((a,b)=>a+b.lineNew,0);
    const sumOld = items.reduce((a,b)=>a+b.lineOld,0);
    const save = Math.max(0, sumOld - sumNew);

    let msg = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Ù…Ø¹Ø±Ø¶ Ø§Ù„ÙØ±Ø¯ÙˆØ³%0A%0A`;
    msg += `Ø§Ù„Ø§Ø³Ù…: ${encodeURIComponent(name)}%0A`;
    msg += `Ø§Ù„Ù‡Ø§ØªÙ: ${encodeURIComponent(phone)}%0A`;
    msg += `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${encodeURIComponent(address)}%0A`;
    if(note) msg += `Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${encodeURIComponent(note)}%0A`;
    msg += `%0AØ§Ù„Ù…Ù†ØªØ¬Ø§Øª:%0A`;

    items.forEach((it,i)=>{
      const line = `${i+1}) ${it.name} | Ø¹Ø¯Ø¯: ${it.qty} | Ø³Ø¹Ø±: ${it.price} | Ù…Ø¬Ù…ÙˆØ¹: ${it.lineNew}`;
      msg += `${encodeURIComponent(line)}%0A`;
    });

    msg += `%0AØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…: ${sumOld}%0A`;
    msg += `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…: ${sumNew}%0A`;
    msg += `Ø§Ù„ØªÙˆÙÙŠØ±: ${save}%0A`;

    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, "_blank");
  }

  function showOverlay(on){
    const o=$("overlay");
    if(on) o.classList.add("show");
    else o.classList.remove("show");
  }
  function closeAll(){
    showOverlay(false);
    $("cartDrawer").classList.remove("open");
    $("prodDrawer").classList.remove("open");
  }

  function scrollToShop(){ $("shopTop").scrollIntoView({behavior:"smooth"}); }

  $("q").addEventListener("input", renderProducts);

  load();
</script>
</body>
</html>
