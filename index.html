<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø¹Ø±Ø¶ Ø§Ù„ÙØ±Ø¯ÙˆØ³</title>

  <!-- PWA / Safari -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b3bbd">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Ù…Ø¹Ø±Ø¶ Ø§Ù„ÙØ±Ø¯ÙˆØ³">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{
      --bg:#f6f8ff;
      --paper:#ffffff;
      --ink:#0b1220;
      --muted:#5b677a;
      --line:#e6ebf5;
      --brand:#0b3bbd;
      --brand2:#1e66f5;
      --ok:#16a34a;
      --danger:#ef4444;
      --shadow:0 10px 30px rgba(11,18,32,.10);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, "Segoe UI", Tahoma, Arial;
      color:var(--ink); background:var(--bg);
    }
    a{color:inherit; text-decoration:none}
    button{font-family:inherit}

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .bar{
      max-width:1200px; margin:auto;
      padding:10px 12px;
      display:grid; grid-template-columns: 1fr auto 1fr;
      align-items:center; gap:10px;
    }
    .brand{
      justify-self:center;
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 10px 24px rgba(11,59,189,.22);
    }
    .brand .t{
      font-weight:1000; letter-spacing:.2px;
      font-size:18px; line-height:1.05;
      text-align:center;
    }
    .brand .s{
      font-size:12px; color:var(--muted); text-align:center; margin-top:2px;
    }

    .leftTools, .rightTools{display:flex; gap:8px; align-items:center}
    .leftTools{justify-self:start}
    .rightTools{justify-self:end}
    .iconBtn{
      border:1px solid var(--line);
      background:var(--paper);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      box-shadow: 0 6px 16px rgba(11,18,32,.06);
      display:flex; gap:8px; align-items:center;
      font-weight:900;
    }
    .pill{
      border:1px solid var(--line);
      background:var(--paper);
      border-radius:999px;
      padding:10px 12px;
      width:min(520px, 92vw);
      display:flex; gap:10px; align-items:center;
      box-shadow: 0 6px 16px rgba(11,18,32,.06);
    }
    .pill input{
      border:0; outline:0; width:100%;
      background:transparent; font-size:14px;
    }
    .badge{
      min-width:22px; height:22px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      background:rgba(11,59,189,.10);
      border:1px solid rgba(11,59,189,.18);
      font-size:12px; font-weight:1000;
    }

    /* Hide parts on scroll: keep only brand */
    header.compact .pill,
    header.compact .rightTools,
    header.compact .leftTools{display:none}
    header.compact .bar{grid-template-columns:1fr}
    header.compact .brand{justify-self:center}

    /* Layout */
    .wrap{max-width:1200px; margin:auto; padding:14px 12px}
    .hero{
      border-radius: var(--r);
      background: linear-gradient(135deg, rgba(11,59,189,.12), rgba(30,102,245,.08));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      padding:16px;
      display:grid; gap:12px;
      grid-template-columns: 1.1fr .9fr;
      align-items:center;
    }
    @media (max-width: 900px){
      .hero{grid-template-columns:1fr}
    }
    .hero h1{margin:0; font-size:22px; font-weight:1000}
    .hero p{margin:6px 0 0; color:var(--muted); line-height:1.6}
    .hero .ctaRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .cta{
      border:0; cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      font-weight:1000;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:white;
      box-shadow: 0 10px 22px rgba(11,59,189,.18);
    }
    .cta.ghost{
      background:var(--paper);
      border:1px solid var(--line);
      color:var(--ink);
      box-shadow: 0 6px 16px rgba(11,18,32,.06);
    }

    /* Category blocks (qn style sections) */
    .secHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:16px 0 10px}
    .secHead .h{font-size:16px; font-weight:1000}
    .secHead .sub{color:var(--muted); font-size:13px}
    .catsGrid{
      display:grid; gap:12px;
      grid-template-columns: repeat(3, 1fr);
    }
    @media (max-width: 900px){
      .catsGrid{grid-template-columns: 1fr}
    }
    .catCard{
      position:relative;
      border-radius: var(--r);
      border:1px solid var(--line);
      background: #eef3ff;
      overflow:hidden;
      box-shadow: var(--shadow);
      min-height: 150px;
      display:flex; align-items:flex-end;
    }
    .catImg{
      position:absolute; inset:0;
      background-size:cover; background-position:center;
      filter:saturate(1.05);
      transform: scale(1.02);
    }
    .catShade{
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,.62));
    }
    .catContent{
      position:relative;
      padding:14px;
      width:100%;
      color:#fff;
      display:flex; justify-content:space-between; align-items:end; gap:10px;
    }
    .catTitle{font-weight:1000; font-size:18px}
    .catBrand{opacity:.85; font-size:12px; margin-top:4px}
    .catBtn{
      border:0; cursor:pointer;
      padding:10px 12px;
      border-radius:14px;
      background:#fff;
      color:#111;
      font-weight:1000;
      white-space:nowrap;
    }

    /* Product grid */
    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(4, 1fr);
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 720px){ .grid{grid-template-columns: repeat(2, 1fr);} }

    .card{
      border:1px solid var(--line);
      background:var(--paper);
      border-radius: var(--r);
      box-shadow: 0 10px 24px rgba(11,18,32,.08);
      overflow:hidden;
    }
    .img{
      width:100%;
      height:160px;
      object-fit:contain;
      background:#f3f6ff;
      display:block;
    }
    @media (max-width: 720px){
      .img{height:140px}
    }
    .p{padding:10px}
    .name{font-weight:1000; font-size:13.5px; line-height:1.25; min-height:34px}
    .cat{font-size:12px; color:var(--muted); margin-top:6px}
    .row{display:flex; align-items:baseline; gap:8px; margin-top:10px; flex-wrap:wrap}
    .price{font-weight:1000; color:var(--brand); font-size:14px}
    .old{font-size:12px; color:var(--muted); text-decoration:line-through}
    .btnRow{display:flex; gap:8px; margin-top:10px}
    .btn{
      flex:1;
      border-radius:14px;
      padding:10px 10px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:1000;
    }
    .btn.add{background:rgba(11,59,189,.10); border-color:rgba(11,59,189,.18)}
    .btn.buy{background: linear-gradient(135deg, var(--ok), #22c55e); color:#fff; border-color:transparent}
    .tag{
      position:absolute; top:10px; right:10px;
      background:rgba(239,68,68,.95);
      color:#fff;
      font-weight:1000;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
    }
    .tag2{
      position:absolute; top:10px; left:10px;
      background:rgba(11,59,189,.95);
      color:#fff;
      font-weight:1000;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
    }
    .posRel{position:relative}

    /* Drawers (Quick View + Cart) */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.50); display:none; z-index:90}
    .drawer{
      position:fixed; top:0; left:0;
      height:100vh; width:min(420px, 92vw);
      background:#fff;
      box-shadow: 0 30px 70px rgba(0,0,0,.25);
      transform: translateX(-110%);
      transition: .2s ease;
      z-index:100;
      display:flex; flex-direction:column;
    }
    .drawer.open{transform:translateX(0)}
    .overlay.show{display:block}
    .dHead{padding:14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; gap:10px}
    .dHead .t{font-weight:1000}
    .x{border:1px solid var(--line); background:#fff; border-radius:12px; padding:8px 10px; cursor:pointer; font-weight:1000}
    .dBody{padding:14px; overflow:auto; flex:1}
    .dFoot{padding:14px; border-top:1px solid var(--line); background:#fafbff}

    .mini{color:var(--muted); font-size:13px; line-height:1.55}
    .form{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .form input, .form textarea{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
      font-weight:700;
      background:#fff;
    }
    .form .full{grid-column:1 / -1}
    .sumLine{display:flex; justify-content:space-between; color:var(--muted); font-size:13px; margin-top:6px}
    .sumLine b{color:var(--ink)}
    .send{
      width:100%;
      border:0; cursor:pointer;
      border-radius:14px;
      padding:12px 12px;
      font-weight:1000;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#fff;
    }
    .clear{
      width:100%;
      border:1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.06);
      color:var(--danger);
      border-radius:14px;
      padding:12px 12px;
      font-weight:1000;
      cursor:pointer;
      margin-top:8px;
    }

    .cartRow{
      display:flex; gap:10px;
      padding:10px 0;
      border-bottom:1px solid var(--line);
      align-items:flex-start;
    }
    .thumb{width:58px; height:58px; border-radius:14px; object-fit:contain; background:#f3f6ff; border:1px solid var(--line)}
    .cMain{flex:1}
    .cName{font-weight:1000; font-size:13px}
    .cMeta{color:var(--muted); font-size:12px; margin-top:6px}
    .qty{display:flex; gap:8px; align-items:center; margin-top:8px}
    .qbtn{width:32px; height:32px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:1000}
  </style>
</head>

<body>
<header id="head">
  <div class="bar">
    <div class="leftTools">
      <button class="iconBtn" onclick="openCart()">ğŸ›’ Ø§Ù„Ø³Ù„Ø© <span class="badge" id="cartCount">0</span></button>
    </div>

    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="t">Ù…Ø¹Ø±Ø¶ Ø§Ù„ÙØ±Ø¯ÙˆØ³</div>
        <div class="s">ØªØ³ÙˆÙ‚ Ø³Ø±ÙŠØ¹ â€¢ Ø·Ù„Ø¨ ÙˆØ§ØªØ³Ø§Ø¨</div>
      </div>
    </div>

    <div class="rightTools">
      <button class="iconBtn" onclick="scrollToShop()">ğŸ›ï¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
    </div>
  </div>

  <div style="display:flex; justify-content:center; padding:0 12px 12px">
    <div class="pill">
      ğŸ”
      <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." />
    </div>
  </div>
</header>

<div class="wrap">
  <!-- Hero -->
  <section class="hero">
    <div>
      <h1>Ø£Ù‚Ø³Ø§Ù… Ù…Ø±ØªÙ‘Ø¨Ø© Ù…Ø«Ù„ Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø§Ù„ÙƒØ¨ÙŠØ±Ø©</h1>
      <p>Ø§Ø®ØªØ§Ø± Ø§Ù„Ù‚Ø³Ù…ØŒ Ø´ÙˆÙ Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ Ø§ÙØªØ­ Quick ViewØŒ ÙˆØ§Ø¬Ù…Ø¹ Ø·Ù„Ø¨Ùƒâ€¦ ÙˆØ¨Ø¶ØºØ·Ø© ÙˆØ­Ø¯Ø© ÙŠØ±ÙˆØ­ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„.</p>
      <div class="ctaRow">
        <button class="cta" onclick="scrollToCats()">Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
        <button class="cta ghost" onclick="scrollToShop()">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
      </div>
    </div>
    <div class="mini">
      âœ… ØªØµÙ…ÙŠÙ… Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ù‹Ø§<br>
      âœ… Quick View Ù…Ø«Ù„ qn-store<br>
      âœ… Ø³Ù„Ø© + Ø§Ø³Ù…/Ù‡Ø§ØªÙ/Ø¹Ù†ÙˆØ§Ù† + Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨
    </div>
  </section>

  <!-- Categories blocks -->
  <div class="secHead">
    <div>
      <div class="h">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
      <div class="sub">Ø§Ø®ØªÙØ± Ù‚Ø³Ù… Ø«Ù… â€œØ¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øªâ€</div>
    </div>
  </div>

  <div id="catsGrid" class="catsGrid"></div>

  <!-- Shop -->
  <div class="secHead" id="shopTop">
    <div>
      <div class="h">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
      <div class="sub" id="status">ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <div id="grid" class="grid"></div>
</div>

<!-- Overlay + Drawer (Cart) -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>

<div class="drawer" id="cartDrawer" aria-hidden="true">
  <div class="dHead">
    <div class="t">ğŸ›’ Ø§Ù„Ø³Ù„Ø© ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</div>
    <button class="x" onclick="closeAll()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <div class="dBody" id="cartBody"></div>
  <div class="dFoot">
    <div class="sumLine"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span> <b id="sumNew">0 Ø¯.Ø¹</b></div>
    <div class="sumLine"><span>Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:</span> <span id="sumOld">0 Ø¯.Ø¹</span></div>
    <div class="sumLine"><span>Ø§Ù„ØªÙˆÙÙŠØ±:</span> <span id="sumSave">0 Ø¯.Ø¹</span></div>

    <div class="form">
      <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" />
      <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
      <input id="address" class="full" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„ + Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø©" />
      <textarea id="note" class="full" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
    </div>

    <button class="send" onclick="sendWhatsApp()">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</button>
    <button class="clear" onclick="clearCart()">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
  </div>
</div>

<!-- Drawer (Quick View) -->
<div class="drawer" id="viewDrawer" style="left:auto; right:0; transform:translateX(110%)" aria-hidden="true">
  <div class="dHead">
    <div class="t" id="vTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</div>
    <button class="x" onclick="closeAll()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <div class="dBody" id="viewBody"></div>
</div>

<script>
  // ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ ======
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vToXcV323xvYtiuz6tg-d0q_f2iwOwnYBpCRqAgSnarQ2PYVZ9Z1GJKlSmftjuajtlJ6zBfmVbRwArp/pub?output=csv";
  const WHATSAPP_NUMBER = "9647719183122";

  // SW (Ø³Ø±Ø¹Ø©)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
  }

  const $ = (id)=>document.getElementById(id);

  const state = {
    products: [],
    cats: [],
    activeCat: "",
    cart: loadCart()
  };

  function loadCart(){ try { return JSON.parse(localStorage.getItem("cart")||"{}"); } catch { return {}; } }
  function saveCart(){ localStorage.setItem("cart", JSON.stringify(state.cart)); updateCartCount(); }

  // CSV parser ÙŠØ¯Ø¹Ù… Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ ÙØ§ØµÙ„Ø© Ø¯Ø§Ø®Ù„ " "
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const headers = splitLine(lines[0]).map(x=>x.trim());
    return lines.slice(1).map(line=>{
      const cols = splitLine(line);
      const obj = {};
      headers.forEach((h,i)=>obj[h]=(cols[i]||"").trim());
      return obj;
    });
  }
  function splitLine(line){
    const out=[]; let cur=""; let inQ=false;
    for (let i=0;i<line.length;i++){
      const c=line[i];
      if (c === '"'){ inQ=!inQ; continue; }
      if (c === "," && !inQ){ out.push(cur); cur=""; continue; }
      cur += c;
    }
    out.push(cur);
    return out;
  }

  function money(n){ return (Number(n)||0).toLocaleString("ar-IQ"); }
  function pct(oldP, newP){
    oldP=Number(oldP||0); newP=Number(newP||0);
    if (!oldP || oldP<=newP) return 0;
    return Math.round(((oldP-newP)/oldP)*100);
  }
  function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  async function load(){
    try{
      const res = await fetch(SHEET_CSV_URL, {cache:"no-store"});
      const text = await res.text();
      const rows = parseCSV(text);

      // ÙÙ„ØªØ±Ø© Ù‚ÙˆÙŠØ© Ù„Ù…Ù†Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
      state.products = rows
        .map((r, idx)=>({
          _i: idx,
          id: String(r.id||"").trim(),
          name: (r.name||"").trim(),
          price: Number(r.price||0),
          old_price: Number(r.old_price||0),
          offer: String(r.offer||"").toLowerCase().trim()==="yes",
          discount_note: (r.discount_note||"").trim(),
          image: (r.image||"").trim(),
          category: (r.category||"ØºÙŠØ± Ù…ØµÙ†Ù").trim(),
          desc: (r.desc||"").trim()
        }))
        .filter(p=>p.id && p.name && p.price);

      state.cats = [...new Set(state.products.map(p=>p.category))].sort((a,b)=>a.localeCompare(b,"ar"));

      $("status").textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${state.products.length} Ù…Ù†ØªØ¬`;
      renderCategoryBlocks();
      renderProducts();
      updateCartCount();
    }catch(e){
      $("status").textContent = "ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· CSV ÙˆØ£Ù† Ø§Ù„Ø´ÙŠØª Ù…Ù†Ø´ÙˆØ±.";
      console.error(e);
    }
  }

  // Category blocks like qn-store home
  function renderCategoryBlocks(){
    const wrap = $("catsGrid");
    wrap.innerHTML = "";

    state.cats.forEach(cat=>{
      // ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø³Ù…: Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„ Ù…Ù†ØªØ¬ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù‚Ø³Ù… (Ø£Ù‚Ø±Ø¨ Ù„Ø£Ø³Ù„ÙˆØ¨ qn-store)
      const p = state.products.find(x=>x.category===cat);
      const bg = p?.image ? `url('${p.image.replace(/'/g,"%27")}')` : "";
      const brand = guessBrandFromCat(cat);

      const el = document.createElement("div");
      el.className = "catCard";
      el.innerHTML = `
        <div class="catImg" style="background-image:${bg?`linear-gradient(135deg, rgba(11,59,189,.25), rgba(0,0,0,.05)), ${bg}`:`linear-gradient(135deg, rgba(11,59,189,.22), rgba(30,102,245,.10))`};"></div>
        <div class="catShade"></div>
        <div class="catContent">
          <div>
            <div class="catTitle">${esc(cat)}</div>
            <div class="catBrand">${esc(brand)}</div>
          </div>
          <button class="catBtn" onclick="showCategory('${cat.replace(/'/g,"\\'")}')">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
        </div>
      `;
      wrap.appendChild(el);
    });
  }

  function guessBrandFromCat(cat){
    // Ù…Ø¬Ø±Ø¯ Ù†Øµ Ø«Ø§Ù†ÙˆÙŠ Ù…Ø«Ù„ qn-store (Ù…Ùˆ Ø¥Ù„Ø²Ø§Ù…ÙŠ)
    if (cat.includes("Ø¹Ø·ÙˆØ±")) return "Perfume";
    if (cat.includes("Ù…ÙƒÙŠØ§Ø¬")) return "Makeup";
    if (cat.includes("ØºØ³ÙˆÙ„Ø§Øª")) return "Skincare";
    return "Collection";
  }

  function showCategory(cat){
    state.activeCat = cat;
    $("shopTop").scrollIntoView({behavior:"smooth"});
    renderProducts();
  }

  function baseFilter(){
    const q = ($("q").value||"").toLowerCase().trim();
    const cat = state.activeCat;
    return state.products.filter(p=>{
      const okC = !cat || p.category===cat;
      const okQ = !q || p.name.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q);
      return okC && okQ;
    });
  }

  function renderProducts(){
    const list = baseFilter().sort((a,b)=>a._i-b._i);
    const grid = $("grid");
    grid.innerHTML = "";

    list.forEach(p=>{
      const hasDisc = p.old_price && p.old_price>p.price;
      const disc = hasDisc ? pct(p.old_price, p.price) : 0;

      const card = document.createElement("div");
      card.className = "card posRel";
      card.innerHTML = `
        ${hasDisc ? `<div class="tag">Ø®ØµÙ… ${disc}%</div>` : ``}
        ${p.offer ? `<div class="tag2">${esc(p.discount_note || "Ø¹Ø±Ø¶ Ø®Ø§Øµ")}</div>` : ``}
        <img class="img" src="${esc(p.image)}" alt="${esc(p.name)}" loading="lazy" onerror="this.style.display='none'">
        <div class="p">
          <div class="name">${esc(p.name)}</div>
          <div class="cat">${esc(p.category)}</div>
          <div class="row">
            <div class="price">${money(p.price)} Ø¯.Ø¹</div>
            ${hasDisc ? `<div class="old">${money(p.old_price)} Ø¯.Ø¹</div>` : ``}
          </div>
          <div class="btnRow">
            <button class="btn add" onclick="addToCart('${p.id}')">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
            <button class="btn buy" onclick="openQuickView('${p.id}')">Quick View</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  // Quick View drawer (like qn-store)
  function openQuickView(id){
    const p = state.products.find(x=>x.id===id);
    if(!p) return;
    $("vTitle").textContent = p.name;
    const hasDisc = p.old_price && p.old_price>p.price;

    $("viewBody").innerHTML = `
      <img class="img" style="height:220px;border-radius:16px" src="${esc(p.image)}" onerror="this.style.display='none'">
      <div style="margin-top:10px;font-weight:1000;font-size:16px">${esc(p.name)}</div>
      <div class="mini" style="margin-top:6px">${esc(p.desc || "")}</div>
      <div class="row" style="margin-top:12px">
        <div class="price">${money(p.price)} Ø¯.Ø¹</div>
        ${hasDisc ? `<div class="old">${money(p.old_price)} Ø¯.Ø¹</div>` : ``}
      </div>
      <div class="btnRow" style="margin-top:12px">
        <button class="btn add" onclick="addToCart('${p.id}')">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
        <button class="btn buy" onclick="buyNow('${p.id}')">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
      </div>
    `;

    showOverlay(true);
    $("viewDrawer").classList.add("open");
  }

  function addToCart(id){
    state.cart[id] = (state.cart[id]||0) + 1;
    saveCart();
  }
  function buyNow(id){
    addToCart(id);
    openCart();
  }

  function updateCartCount(){
    const c = Object.values(state.cart).reduce((a,b)=>a+b,0);
    $("cartCount").textContent = c;
  }

  function cartItems(){
    return Object.entries(state.cart).map(([id,qty])=>{
      const p = state.products.find(x=>x.id===id);
      if(!p) return null;
      const oldp = p.old_price && p.old_price>0 ? p.old_price : p.price;
      return { ...p, qty, lineNew:p.price*qty, lineOld:oldp*qty };
    }).filter(Boolean);
  }

  function openCart(){
    renderCart();
    showOverlay(true);
    $("cartDrawer").classList.add("open");
  }

  function renderCart(){
    const items = cartItems();
    const body = $("cartBody");

    if(!items.length){
      body.innerHTML = `<div class="mini">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.</div>`;
    }else{
      body.innerHTML = items.map(it=>`
        <div class="cartRow">
          <img class="thumb" src="${esc(it.image)}" onerror="this.style.display='none'">
          <div class="cMain">
            <div class="cName">${esc(it.name)}</div>
            <div class="cMeta">${money(it.price)} Ø¯.Ø¹ â€¢ Ø¹Ø¯Ø¯: ${it.qty}</div>
            <div class="qty">
              <button class="qbtn" onclick="dec('${it.id}')">-</button>
              <b>${it.qty}</b>
              <button class="qbtn" onclick="inc('${it.id}')">+</button>
              <button class="qbtn" style="margin-inline-start:auto" onclick="removeItem('${it.id}')">âœ•</button>
            </div>
          </div>
        </div>
      `).join("");
    }

    const sumNew = items.reduce((a,b)=>a+b.lineNew,0);
    const sumOld = items.reduce((a,b)=>a+b.lineOld,0);
    const save = Math.max(0, sumOld - sumNew);

    $("sumNew").textContent = `${money(sumNew)} Ø¯.Ø¹`;
    $("sumOld").textContent = `${money(sumOld)} Ø¯.Ø¹`;
    $("sumSave").textContent = `${money(save)} Ø¯.Ø¹`;
  }

  function inc(id){ state.cart[id]=(state.cart[id]||0)+1; saveCart(); renderCart(); }
  function dec(id){
    if(!state.cart[id]) return;
    state.cart[id]--;
    if(state.cart[id]<=0) delete state.cart[id];
    saveCart(); renderCart();
  }
  function removeItem(id){ delete state.cart[id]; saveCart(); renderCart(); }
  function clearCart(){ state.cart={}; saveCart(); renderCart(); }

  function sendWhatsApp(){
    const items = cartItems();
    if(!items.length){ alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©"); return; }

    const name = $("name").value.trim();
    const phone = $("phone").value.trim();
    const address = $("address").value.trim();
    const note = $("note").value.trim();

    if(!name || !phone || !address){
      alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ù‡Ø§ØªÙ + Ø§Ù„Ø¹Ù†ÙˆØ§Ù†");
      return;
    }

    const sumNew = items.reduce((a,b)=>a+b.lineNew,0);
    const sumOld = items.reduce((a,b)=>a+b.lineOld,0);
    const save = Math.max(0, sumOld - sumNew);

    let msg = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Ù…Ø¹Ø±Ø¶ Ø§Ù„ÙØ±Ø¯ÙˆØ³%0A%0A`;
    msg += `Ø§Ù„Ø§Ø³Ù…: ${encodeURIComponent(name)}%0A`;
    msg += `Ø§Ù„Ù‡Ø§ØªÙ: ${encodeURIComponent(phone)}%0A`;
    msg += `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${encodeURIComponent(address)}%0A`;
    if(note) msg += `Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${encodeURIComponent(note)}%0A`;
    msg += `%0AØ§Ù„Ù…Ù†ØªØ¬Ø§Øª:%0A`;

    items.forEach((it,i)=>{
      const line = `${i+1}) ${it.name} | Ø¹Ø¯Ø¯: ${it.qty} | Ø³Ø¹Ø±: ${it.price} | Ù…Ø¬Ù…ÙˆØ¹: ${it.lineNew}`;
      msg += `${encodeURIComponent(line)}%0A`;
    });

    msg += `%0AØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…: ${sumOld}%0A`;
    msg += `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…: ${sumNew}%0A`;
    msg += `Ø§Ù„ØªÙˆÙÙŠØ±: ${save}%0A`;

    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, "_blank");
  }

  function showOverlay(on){
    const o=$("overlay");
    if(on) o.classList.add("show");
    else o.classList.remove("show");
  }
  function closeAll(){
    showOverlay(false);
    $("cartDrawer").classList.remove("open");
    $("viewDrawer").classList.remove("open");
  }

  function scrollToCats(){ document.getElementById("catsGrid").scrollIntoView({behavior:"smooth"}); }
  function scrollToShop(){ document.getElementById("shopTop").scrollIntoView({behavior:"smooth"}); }

  $("q").addEventListener("input", renderProducts);

  // header compact on scroll (ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·)
  window.addEventListener("scroll", ()=>{
    $("head").classList.toggle("compact", window.scrollY > 70);
  });

  load();
</script>
</body>
</html>
